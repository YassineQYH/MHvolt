{% extends 'base.html.twig' %}

{% block title %}Ma commande : Hich-Trott{% endblock %}

{% block content %}
<div class="container mt-5" style="max-width: 80%;">
    <h1>Ma commande {{ order.reference }}</h1>
    <a href="{{ path('account_order') }}">‚Üê Retour</a>

    {# üßæ Boutons PDF #}
    <div class="d-flex mt-3 mb-3">
        <a href="{{ path('account_order_invoice_web', { reference: order.reference }) }}"
           class="btn btn-secondary btn-sm w-auto me-2"
           target="_blank">
            Voir la facture
        </a>

        <a href="{{ path('account_order_invoice', { reference: order.reference }) }}?download=1"
           class="btn btn-primary btn-sm w-auto">
            T√©l√©charger la facture (PDF)
        </a>
    </div>

    <hr>

    {# Statut de la commande #}
    <strong>Statut de la commande :</strong>
    <div>
        {% if order.deliveryState == 4 %}
            <span class="badge bg-danger">Annul√©e</span>
        {% elseif order.paymentState == 0 %}
            <span class="badge bg-danger">Non pay√©e</span>
        {% elseif order.deliveryState == 0 %}
            <span class="badge bg-secondary">Commande valid√©e</span>
        {% elseif order.deliveryState == 1 %}
            <span class="badge bg-warning">Pr√©paration en cours</span>
        {% elseif order.deliveryState == 2 %}
            <span class="badge bg-info">Livraison en cours</span>
        {% elseif order.deliveryState == 3 %}
            <span class="badge bg-success">Livraison termin√©e</span>
        {% else %}
            <span class="badge bg-secondary">En attente</span>
        {% endif %}
    </div><br>

    <strong>Commande pass√©e le :</strong> {{ order.createdAt|date('d/m/Y') }}<br>
    <strong>R√©f√©rence de ma commande :</strong> <small>{{ order.reference }}</small><br>
    <hr>

    <strong>D√©tails :</strong>

    <table class="table table-striped mt-4">
        <thead class="thead-dark">
            <tr>
                <th>Produit</th>
                <th>Quantit√©</th>
                <th>Poids</th>
                <th>Prix unitaire HT</th>
                <th>Prix unitaire TTC</th>
                <th>Total HT</th>
                <th>Total TTC</th>
            </tr>
        </thead>
        <tbody>
            {% set totalHT = 0 %}
            {% set totalTTC = 0 %}

            {% for item in order.orderDetails %}
                {% set totalItemHT = item.price * item.quantity %}
                {% set totalItemTTC = totalItemHT * (1 + (item.tva / 100)) %}
                <tr>
                    <td>
                        {% set illustration = (item.productEntity is defined and item.productEntity and item.productEntity.illustrations|length > 0)
                            ? item.productEntity.illustrations|first
                            : null %}
                        <img src="/uploads/{{ item.productEntity.uploadDirectory }}/{{ illustration ? illustration.image : 'default.jpg' }}"
                            alt="{{ item.product }}"
                            style="width:50px; height:auto; margin-right:10px;">
                        {{ item.product }}
                    </td>
                    <td>x{{ item.quantity }}</td>
                    <td>{{ (item.productEntity.weight ?? item.weight) * item.quantity }} kg</td>
                    <td>{{ item.price|number_format(2, ',', '.') }} ‚Ç¨</td>
                    <td>{{ (item.price * (1 + item.tva / 100))|number_format(2, ',', '.') }} ‚Ç¨</td>
                    <td>{{ totalItemHT|number_format(2, ',', '.') }} ‚Ç¨</td>
                    <td>{{ totalItemTTC|number_format(2, ',', '.') }} ‚Ç¨</td>
                </tr>
                {% set totalHT = totalHT + totalItemHT %}
                {% set totalTTC = totalTTC + totalItemTTC %}
            {% endfor %}
        </tbody>
    </table>

    {# Totaux de la commande #}
    {% set promo = order.promoReduction ?? 0 %}
    {% set totalCommande = totalTTC - promo + order.carrierPrice %}

    <table class="table table-bordered mt-4" style="max-width: 400px; float: right;">
        <tbody>
            <tr>
                <td><strong>Total produits HT :</strong></td>
                <td class="text-end">{{ totalHT|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            <tr>
                <td><strong>TVA :</strong></td>
                <td class="text-end">{{ (totalTTC - totalHT)|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            <tr>
                <td><strong>Total produits TTC :</strong></td>
                <td class="text-end">{{ totalTTC|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            {% if promo > 0 %}
            <tr>
                <td><strong>R√©duction ({{ order.promoTitre ?? order.promoCode }}):</strong></td>
                <td class="text-end">-{{ promo|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            {% endif %}
            <tr>
                <td><strong>Frais de livraison :</strong></td>
                <td class="text-end">{{ order.carrierPrice|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            <tr>
                <td><strong>Total commande :</strong></td>
                <td class="text-end">{{ totalCommande|number_format(2, ',', '.') }} ‚Ç¨</td>
            </tr>
            <tr>
                <td><strong>Transporteur :</strong></td>
                <td class="text-end">{{ order.carrier ?? 'Non renseign√©' }}</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}
