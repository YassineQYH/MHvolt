{% extends '@EasyAdmin/page/content.html.twig' %}

{% block content %}
<div class="dashboard-container" style="max-width:1200px; margin:0 auto; padding:20px;">

    <h1>Statistiques MHvolt</h1>

    <!-- Ligne 1 : Commandes par mois et Statut des commandes -->
    <div style="display:flex; flex-wrap:wrap; gap:30px; justify-content:space-between;">

        <div style="flex:1 1 500px; min-width:300px; max-height:400px;">
            <h2>Commandes par mois</h2>

            <!-- Navigation annÃ©es -->
            <div class="year-navigation">
                <a href="#" class="arrow-left" style="visibility:hidden">&larr;</a>

                <span class="current-year">{{ yearToDisplay }}</span>

                <a href="#" class="arrow-right" style="visibility:hidden">&rarr;</a>
            </div>


            <canvas id="ordersByMonth" class="dashboard-canvas"></canvas>
        </div>

        <div style="flex:1 1 400px; min-width:300px; max-height:400px;">
            <h2>Statut des commandes</h2>
            <canvas id="ordersByStatus" class="dashboard-canvas"></canvas>
        </div>

    </div></br></br></br></br>

    <!-- Ligne 2 : Chiffre d'affaires -->
    <div style="margin-top:40px; flex:1 1 100%; min-width:300px; max-height:400px;">
        <h2>Chiffre d'affaires par mois (â‚¬)</h2>
        <canvas id="revenueChart" class="dashboard-canvas"></canvas>
    </div>

</div>

{# Chart.js CDN #}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // -----------------------------
    // DonnÃ©es initiales (Twig)
    // -----------------------------
    const ordersByMonthData = {{ ordersByMonth|json_encode|raw }};
    const orderStatusStats = {{ orderStatusStats|json_encode|raw }};
    const revenueByMonthData = {{ revenueByMonth|json_encode|raw }};

    // -----------------------------
    // ðŸ“Š Commandes par mois (BAR)
    // -----------------------------
    const ordersByMonthChart = new Chart(
        document.getElementById('ordersByMonth'),
        {
            type: 'bar',
            data: {
                labels: ordersByMonthData.labels,
                datasets: [{
                    label: 'Commandes',
                    data: ordersByMonthData.values,
                    backgroundColor: 'rgba(54,162,235,0.7)',
                    borderRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 600, easing: 'easeOutQuart' },
                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } },
                plugins: { legend: { position: 'bottom' } }
            }
        }
    );

    // -----------------------------
    // ðŸ¥§ Statut des commandes (PIE)
    // -----------------------------
    const ordersByStatusChart = new Chart(
        document.getElementById('ordersByStatus'),
        {
            type: 'pie',
            data: {
                labels: orderStatusStats.labels,
                datasets: [{
                    data: orderStatusStats.values,
                    backgroundColor: [
                        '#007bff', '#28a745', '#ffc107', '#17a2b8', '#6c757d', '#dc3545'
                    ]
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
        }
    );

    // -----------------------------
    // ðŸ’° Chiffre d'affaires (LINE)
    // -----------------------------
    const revenueChart = new Chart(
        document.getElementById('revenueChart'),
        {
            type: 'line',
            data: {
                labels: revenueByMonthData.labels,
                datasets: [{
                    label: 'Revenu mensuel (â‚¬)',
                    data: revenueByMonthData.values,
                    fill: true,
                    borderColor: 'rgba(40,167,69,0.9)',
                    backgroundColor: 'rgba(40,167,69,0.2)',
                    tension: 0.3,
                    pointRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: { duration: 600, easing: 'easeOutQuart' },
                scales: { y: { beginAtZero: true } },
                plugins: { legend: { position: 'bottom' } }
            }
        }
    );

    // -----------------------------
    // ðŸ”„ Navigation annÃ©es
    // -----------------------------
    function updateYearNavigation(data) {
        const left = document.querySelector('.arrow-left');
        const right = document.querySelector('.arrow-right');

        if (data.prevYear) {
            left.href = '?year=' + data.prevYear;
            left.textContent = 'â† ' + data.prevYear;
            left.style.visibility = 'visible';
        } else {
            left.style.visibility = 'hidden';
        }

        if (data.nextYear) {
            right.href = '?year=' + data.nextYear;
            right.textContent = data.nextYear + ' â†’';
            right.style.visibility = 'visible';
        } else {
            right.style.visibility = 'hidden';
        }
    }

    // Mise Ã  jour initiale des flÃ¨ches dÃ¨s le chargement
    updateYearNavigation({
        prevYear: {{ prevYear is not null ? prevYear : 'null' }},
        nextYear: {{ nextYear is not null ? nextYear : 'null' }}
    });

    // Gestion du clic AJAX sur les flÃ¨ches
    document.querySelectorAll('.year-navigation a').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();

            if (!this.href || this.style.visibility === 'hidden') {
                return;
            }

            fetch(this.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(res => res.json())
            .then(data => {
                // ðŸ“Š Commandes
                ordersByMonthChart.data.labels = data.ordersByMonth.labels;
                ordersByMonthChart.data.datasets[0].data = data.ordersByMonth.values;
                ordersByMonthChart.update();

                // ðŸ’° Chiffre d'affaires
                revenueChart.data.labels = data.revenueByMonth.labels;
                revenueChart.data.datasets[0].data = data.revenueByMonth.values;
                revenueChart.update();

                // ðŸ—“ï¸ AnnÃ©e affichÃ©e
                document.querySelector('.current-year').textContent = data.yearToDisplay;

                // â¬…ï¸âž¡ï¸ Navigation
                updateYearNavigation(data);
            })
            .catch(err => console.error('Erreur chargement stats:', err));
        });
    });
</script>


<style>
    /* Classe pour harmoniser tous les canvas */
    .dashboard-canvas { height: 300px; max-height: 400px; width: 100%; }
    .year-navigation { display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; }
    .year-navigation a { text-decoration:none; font-weight:bold; color:#007bff; transition: transform 0.2s ease, color 0.2s ease; }
    .year-navigation a:hover { transform:scale(1.1); color:#0056b3; }
    .current-year { font-size:18px; font-weight:bold; }
</style>

{% endblock %}
