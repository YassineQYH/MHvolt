{% extends 'base.html.twig' %}
{% block title %}Mon panier{% endblock %}

{% block menu %}
    {{ include('partials/menu.html.twig') }}
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset('assets/js/code-promo.js') }}"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1>Mon panier</h1>
    <p>Retrouvez l'ensemble des produits que vous avez ajoutés à votre panier.</p>

    {% if cart|length > 0 %}
        {% set totalTTC = 0 %}
        {% set totalWeight = 0 %}
        {% set promoDiscount = cartObject.getDiscountTTC(promoService, allPromotions) %}

        {% set totalTTC = 0 %}
{% set totalWeight = 0 %}

{# Première boucle pour calculer totalTTC et totalWeight #}
{% for item in cart %}
    {% set priceHT = item.product.price %}
    {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
    {% set priceTTC = priceHT * (1 + tvaRate) %}
    {% set totalItemTTC = priceTTC * item.quantity %}
    {% set totalWeight = totalWeight + (item.product.weight.kg * item.quantity) %}
    {% set totalTTC = totalTTC + totalItemTTC %}
{% endfor %}

    {% set promoDiscount = cartObject.getDiscountTTC(promoService, allPromotions) %}

    <table class="table table-striped mt-3">
        <thead class="thead-dark">
            <tr>
                <th scope="col">Produit</th>
                <th scope="col">Quantité</th>
                <th scope="col">Total TTC</th>
                <th scope="col">Poids</th>
                <th scope="col"></th>
            </tr>
        </thead>
        <tbody>
            {% for item in cart %}
                {% set priceHT = item.product.price %}
                {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
                {% set priceTTC = priceHT * (1 + tvaRate) %}
                {% set totalItemTTC = priceTTC * item.quantity %}

                {# Calcul de la remise proportionnelle par produit #}
                {% set totalItemRemise = totalItemTTC %}
                {% if promoDiscount > 0 %}
                    {% set proportion = totalItemTTC / totalTTC %}
                    {% set totalItemRemise = totalItemTTC - (promoDiscount * proportion) %}
                {% endif %}

                {% set illustration = item.product.illustrations|first %}

                <tr>
                    <td>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="width:60px; flex-shrink:0; text-align:center;">
                                <a href="{{ path(item.type == 'accessory' ? 'accessory_show' : 'trottinette_show', { slug: item.product.slug }) }}">
                                    {% if illustration %}
                                        <img src="/uploads/{{ item.product.uploadDirectory }}/{{ illustration.image }}"
                                            alt="{{ item.product.name }}"
                                            style="height:50px; width:auto;">
                                    {% else %}
                                        <img src="/uploads/{{ item.product.uploadDirectory }}/default.jpg"
                                            alt="image par défaut"
                                            style="height:50px; width:auto;">
                                    {% endif %}
                                </a>
                            </div>
                            <span style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                {{ item.product.name }}
                            </span>
                        </div>
                    </td>

                    <td>x{{ item.quantity }}</td>

                    <td>
                        {% if promoDiscount > 0 %}
                            <span style="text-decoration: line-through; color:#888;">
                                {{ totalItemTTC|number_format(2, ',', '.') }} €
                            </span>
                            <br>
                            <span style="color:green; font-weight:bold;">
                                {{ totalItemRemise|number_format(2, ',', '.') }} €
                            </span>
                        {% else %}
                            {{ totalItemTTC|number_format(2, ',', '.') }} €
                        {% endif %}
                    </td>

                    <td>{{ (item.product.weight.kg * item.quantity) }} Kg</td>

                    <td>
                        <a href="{{ path('delete_to_cart', { 'id' : item.product.id, 'type': item.type|default('trottinette') }) }}">
                            <img src="{{ asset('img/delete.png') }}" height="18px" alt="Supprimer">
                        </a>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>


        {% set promoDiscount = cartObject.getDiscountTTC(promoService, allPromotions) %}
        {% set promoCode = cartObject.getPromoCode() %}
        {% set totalLivraison = price %}
        {% set grandTotal = totalTTC - promoDiscount + totalLivraison %}

        <table class="table mt-4" style="max-width:400px; margin-left:auto;">
            <tbody>
                <tr>
                    <td colspan="2">Sous-total</td>
                    <td>
                        {% if promoDiscount > 0 %}
                            <span style="text-decoration: line-through;">{{ totalTTC|number_format(2, ',', '.') }} €</span>
                        {% else %}
                            {{ totalTTC|number_format(2, ',', '.') }} €
                        {% endif %}
                    </td>
                </tr>
                {% if promoDiscount > 0 %}
                    <tr>
                        <td colspan="2">Remise</td>
                        <td>- {{ promoDiscount|number_format(2, ',', '.') }} €</td>
                    </tr>
                    <tr>
                        <td colspan="2">Total après remise</td>
                        <td><strong>{{ (totalTTC - promoDiscount)|number_format(2, ',', '.') }} €</strong></td>
                    </tr>
                {% endif %}
                <tr>
                    <td colspan="2">Livraison</td>
                    <td>{{ totalLivraison|number_format(2, ',', '.') }} €</td>
                </tr>
                <tr>
                    <td colspan="2"><strong>Total</strong></td>
                    <td><strong>{{ grandTotal|number_format(2, ',', '.') }} €</strong></td>
                </tr>
            </tbody>
        </table>


        {# Formulaire pour entrer un nouveau code promo #}
        <form id="promoForm" action="{{ path('cart_apply_promo') }}" method="POST" class="d-flex mt-2" style="max-width:300px; margin-left:auto;">
            <input type="text" name="promo_code" id="promoCode" class="form-control me-2" placeholder="Code promo" value="{{ promoCode ?? '' }}">
            <button class="btn btn-primary" type="submit">Appliquer</button>
        </form>
        <small id="promoMessage" class="text-danger"></small>

        <a href="{{ path('order') }}" class="btn btn-success btn-block mt-3">Valider mon panier</a></br></br>

    {% else %}
        <hr>
        <p><b>Votre panier est vide.</b></p>
    {% endif %}
</div>
{% endblock %}
