{% extends 'base.html.twig' %}

{% block javascript %}
    <script src="https://js.stripe.com/v3/"></script>
{% endblock %}

{% block title %}Valider ma commande - Hich-Trott{% endblock %}

{% block menu %}
    {{ include('partials/menu.html.twig') }}
{% endblock %}

{% block content %}
<div class="container my-5 py-5">
    {% set promoDiscount = promoDiscount|default(0) %}
    {% set promoCode = promoCode|default('') %}

    <h2>Mon r√©capitulatif</h2>
    <p>V√©rifiez vos informations avant de payer votre commande.</p>
    <hr>

    <div class="row">
        <div class="col-md-6">
            <strong>Mon adresse de livraison :</strong><br>

            {% if delivery is defined and delivery is not empty %}
                <div class="form-check mt-4">
                    {{ delivery|raw }}
                </div>
            {% else %}
                <div class="alert alert-warning mt-3">
                    Vous devez <a href="{{ path('account_address_add') }}">ajouter une adresse</a> avant de valider votre commande.
                </div>
            {% endif %}
            <hr>
        </div>

        <div class="col-md-6">
            <div class="text-center">
                <b>Ma commande</b><br>
            </div>

            <div class="order-summary">
                {# === On calcule d'abord le total TTC (produits) comme dans la page panier === #}
                {% set totalTTC = 0 %}
                {% for item in cart %}
                    {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
                    {% set priceTTC = item.product.price * (1 + tvaRate) %}
                    {% set totalItemTTC = priceTTC * item.quantity %}
                    {% set totalTTC = totalTTC + totalItemTTC %}
                {% endfor %}

                {# === Puis on affiche chaque ligne en r√©partissant la remise TTC proportionnellement === #}
                {% for key, item in cart %}
                    {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
                    {% set priceTTC = item.product.price * (1 + tvaRate) %}
                    {% set totalItemTTC = priceTTC * item.quantity %}

                    {# Remise proportionnelle sur la ligne (TTC) - identique √† cart/index.twig #}
                    {% set totalItemRemise = promoDiscount > 0 ? totalItemTTC - (totalItemTTC / (totalTTC ?: 1) * promoDiscount) : totalItemTTC %}
                    {% set illustration = item.product.illustrations|first %}

                    <div class="row {% if key > 0 %}mt-2{% endif %}">
                        <div class="col-4">
                            {% if illustration %}
                                <img src="/uploads/{{ item.product.uploadDirectory }}/{{ illustration.image }}" alt="{{ item.product.name }}" height="75px">
                            {% else %}
                                <img src="/uploads/{{ item.product.uploadDirectory }}/default.jpg" alt="image par d√©faut" height="75px">
                            {% endif %}
                        </div>

                        <div class="col-6 my-auto">
                            {{ item.product.name }}<br>
                            <small>{{ item.product.description }}</small><br>
                            <small>x {{ item.quantity }}</small>
                        </div>

                        <div class="col-2 my-auto text-end">
                            {% if promoDiscount > 0 %}
                                <span style="text-decoration:line-through;color:#888;">
                                    {{ totalItemTTC|number_format(2, ',', '.') }} ‚Ç¨
                                </span><br>
                                <span style="color:green;font-weight:bold;">
                                    {{ totalItemRemise|number_format(2, ',', '.') }} ‚Ç¨
                                </span>
                            {% else %}
                                {{ totalItemTTC|number_format(2, ',', '.') }} ‚Ç¨
                            {% endif %}
                        </div>
                    </div>
                {% endfor %}
            </div>

            <hr>

            {# === Totaux === #}
            <strong>Total produits :</strong> {{ totalTTC|number_format(2, ',', '.') }} ‚Ç¨<br>

            {% if promoDiscount > 0 %}
                <strong style="color:green;">R√©duction ({{ promoTitre }}):</strong>
                <span style="color:red;">-{{ promoDiscount|number_format(2, ',', '.') }} ‚Ç¨</span><br>

                {# Calcul du sous-total remis√©: total produits TTC - promo (TTC) #}
                {% set subtotalRemise = totalTTC - promoDiscount %}
                <strong>Sous-total remis√© :</strong> {{ subtotalRemise|number_format(2, ',', '.') }} ‚Ç¨<br>
            {% else %}
                {% set subtotalRemise = totalTTC %}
            {% endif %}

            <strong>Livraison :</strong> {{ price|number_format(2, ',', '.') }} ‚Ç¨<br>

            <strong>Total √† payer :</strong>
            <span style="font-weight:bold; color:black;">
                {{ (subtotalRemise + price)|number_format(2, ',', '.') }} ‚Ç¨
            </span><br>

            <small class="text-muted">TVA incluse</small>

            {% if delivery is defined and delivery is not empty %}
                {# üîó Lien direct vers Stripe : le controller g√®re la session et la redirection #}
                <a href="{{ path('stripe_create_session', {'reference': reference}) }}"
                   class="btn btn-success btn-block mt-3">
                    Payer | {{ (subtotalRemise + price)|number_format(2, ',', '.') }} ‚Ç¨
                </a>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
