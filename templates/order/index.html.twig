{% extends 'base.html.twig' %}

{% block title %}Valider ma commande : Hich-Trott{% endblock %}

{% block menu %}
    {{ include('partials/menu.html.twig') }}
{% endblock %}

{% block content %}<br><br><br><br><br><br><br>

<div class="container">
    <h2>Je passe ma commande</h2>
    <p>Choisissez vos préférences avant de passer votre commande sur La Boutique Hich-Trott.</p>
    <hr>

    <div class="row">

        {# ------------------- FORMULAIRE ------------------- #}
        <div class="col-md-6">
            {% set formHtml %}
                {{ form_start(form, {action:path('order_recap')}) }}
                    {{ form_widget(form.addresses) }}
                    {{ form_widget(form.submit) }}
                    <a href="{{ path('account_address_add') }}">Ajouter une nouvelle adresse</a>
                {{ form_end(form) }}
            {% endset %}

            {{ formHtml|replace({'[br]' : '</br>'})|raw }}
        </div>

        {# ------------------- RÉCAP PANIER ------------------- #}
        <div class="col-md-6">

            <div class="text-center">
                <b>Récap de ma commande</b></br>
                <p>Retrouvez le récapitulatif de vos produits.</p>
            </div>

            {# === Récupération baisse promo (auto + code) === #}
            {% set promoDiscount = cartObject.getDiscountTTC(promoService, allPromotions) %}
            {% set promoCode = cartObject.getPromoCode() %}

            {# === Calcul du total TTC AVANT remise === #}
            {% set totalTTC = 0 %}

            {% for item in cart %}
                {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
                {% set priceTTC = item.product.price * (1 + tvaRate) %}
                {% set totalItemTTC = priceTTC * item.quantity %}
                {% set totalTTC = totalTTC + totalItemTTC %}
            {% endfor %}

            {# ------------------- LISTE PRODUITS ------------------- #}
            <div class="order-summary">

                {% for key, item in cart %}

                    {% set tvaRate = item.product.tva ? (item.product.tva.value / 100) : 0 %}
                    {% set priceTTC = item.product.price * (1 + tvaRate) %}
                    {% set totalItemTTC = priceTTC * item.quantity %}

                    {# ----- REMISE PAR PROPORTION ----- #}
                    {% set totalItemRemise = totalItemTTC %}

                    {% if promoDiscount > 0 %}
                        {% set proportion = totalItemTTC / totalTTC %}
                        {% set totalItemRemise = totalItemTTC - (promoDiscount * proportion) %}
                    {% endif %}

                    <div class="row {% if key > 0 %}mt-2{% endif %}">

                        <div class="col-4">
                            {% set illustration = item.product.illustrations|first %}
                            {% if illustration %}
                                <img src="/uploads/{{ item.product.uploadDirectory }}/{{ illustration.image }}"
                                    alt="{{ item.product.name }}" height="75px">
                            {% else %}
                                <img src="/uploads/{{ item.product.uploadDirectory }}/default.jpg"
                                    alt="image par défaut" height="75px">
                            {% endif %}
                        </div>

                        <div class="col-6 my-auto">
                            {{ item.product.name }}<br>

                            {% if promoDiscount > 0 %}
                                <span style="text-decoration: line-through; color:#999;">
                                    {{ totalItemTTC|number_format(2, ',', '.') }} €
                                </span><br>

                                <span style="color:green; font-weight:bold;">
                                    {{ totalItemRemise|number_format(2, ',', '.') }} € TTC
                                </span>
                            {% else %}
                                {{ totalItemTTC|number_format(2, ',', '.') }} € TTC
                            {% endif %}

                            <br>
                            <small>{{ item.product.description }}</small>
                        </div>

                        <div class="col-2 my-auto">
                            x {{ item.quantity }}
                        </div>

                    </div></br>

                {% endfor %}

            </div>

            <hr>

            {# ------------------- TOTAUX ------------------- #}

            <div class="text-right">

                <b>Panier :</b>
                {% if promoDiscount > 0 %}
                    <span style="text-decoration: line-through;">
                        {{ totalTTC|number_format(2, ',', '.') }} €
                    </span><br>
                    <b>Après remise :</b>
                    <span style="color:green;">
                        {{ (totalTTC - promoDiscount)|number_format(2, ',', '.') }} €
                    </span><br>
                {% else %}
                    {{ totalTTC|number_format(2, ',', '.') }} €<br>
                {% endif %}

                <b>Livraison :</b> {{ price|number_format(2, ',', '.') }} €<br>

                {% set totalWithShipping = totalTTC + price %}
                {% set totalFinal = totalWithShipping - promoDiscount %}

                <b>Total TTC :</b>
                <span style="font-size:18px; font-weight:bold;">
                    {{ totalFinal|number_format(2, ',', '.') }} €
                </span>

                {% if promoDiscount > 0 %}
                    <div style="margin-top: 10px; padding: 8px; border: 1px solid #28a745; border-radius: 5px; background: #ebffef;">
                        {% if promoCode %}
                            <b>Code promo :</b> {{ promoCode }}<br>
                        {% else %}
                            <b>Promotion automatique</b><br>
                        {% endif %}

                        <b>Remise :</b>
                        <span style="color:red;">
                            -{{ promoDiscount|number_format(2, ',', '.') }} €
                        </span>
                    </div>
                {% endif %}

            </div>

        </div>

    </div>
</div>

{% endblock %}
