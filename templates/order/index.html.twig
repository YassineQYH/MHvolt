{% extends 'base.html.twig' %}

{% block title %}Valider ma commande : Hich-Trott{% endblock %}

{% block menu %}
    {{ include('partials/menu.html.twig') }}
{% endblock %}

{% block content %}<br><br><br><br><br><br><br>
    <div class="container">
        <h2>Je passe ma commande</h2>
        <p>Choisissez vos préférences avant de passer votre commande sur La Boutique Hich-Trott.</p>
        <hr>
        <div class="row">
            <div class="col-md-6">
                {% set formHtml %}
                    {{ form_start(form, {action:path('order_recap')}) }}
                        {{ form_widget(form.addresses) }}
                        {{ form_widget(form.submit) }}
                        <a href="{{ path('account_address_add') }}">Ajouter une nouvelle adresse</a>
                    {{ form_end(form) }}
                {% endset %}

                {{ formHtml|replace({'[br]' : '</br>'})|raw }}
            </div>

            <div class="col-md-6">
                <div class="text-center">
                    <b>Récap de ma commande</b></br>
                    <p>Retrouvez le récapitulatif de vos produits.</p>
                </div>

                <div class="order-summary">
                    {% set totalTTC = 0 %}
                    {% for key, item in cart %}

                        {# TVA dynamique depuis la BDD #}
                        {% if item.product.tva %}
                            {% set tvaRate = item.product.tva.value / 100 %}
                        {% else %}
                            {% set tvaRate = 0 %}
                        {% endif %}

                        {# Calcul TTC #}
                        {% set priceTTC = item.product.price * (1 + tvaRate) %}
                        {% set totalItemTTC = priceTTC * item.quantity %}
                        {% set totalTTC = totalTTC + totalItemTTC %}

                        <div class="row {% if key > 0 %}mt-2{% endif %}">
                            <div class="col-4">
                                {% set illustration = item.product.illustrations|first %}
                                {% if illustration %}
                                    <img src="/uploads/{{ item.product.uploadDirectory }}/{{ illustration.image }}"
                                        alt="{{ item.product.name }}"
                                        height="75px">
                                {% else %}
                                    <img src="/uploads/{{ item.product.uploadDirectory }}/default.jpg"
                                        alt="image par défaut"
                                        height="75px">
                                {% endif %}
                            </div>

                            <div class="col-6 my-auto">
                                {{ item.product.name }} — {{ priceTTC|number_format(2, ',', '.') }} € TTC</br>
                                <small>{{ item.product.description }}</small>
                            </div>

                            <div class="col-2 my-auto">
                                x {{ item.quantity }}
                            </div>
                        </div></br>

                    {% endfor %}
                </div>

                <hr>

                <div class="text-right">

                    {# Prix standard #}
                    <b>Panier :</b> {{ totalTTC|number_format(2, ',', '.') }} €<br>
                    <b>Livraison :</b> {{ price|number_format(2, ',', '.') }} €<br>

                    {% set totalWithShipping = totalTTC + price %}
                    <b>Total TTC :</b> {{ totalWithShipping|number_format(2, ',', '.') }} €<br>

                    {# === Partie CODE PROMO === #}
                    {% set promoDiscount = promoDiscount|default(0) %}
                    {% set promoCode = promoCode|default(null) %}

                    {% if promoDiscount > 0 %}
                        <div style="margin-top: 15px; padding: 10px; border: 1px solid #28a745; border-radius: 5px; background: #ebffef;">
                            <b>Code promo appliqué :</b> <span style="color:green;">{{ promoCode }}</span><br>
                            <b>Réduction :</b> <span style="color:red;">-{{ promoDiscount|number_format(2, ',', '.') }} €</span><br>

                            <b>Total après réduction :</b>
                            <span style="font-weight:bold; color:black;">
                                {{ (totalWithShipping - promoDiscount)|number_format(2, ',', '.') }} €
                            </span>
                        </div>
                    {% endif %}
                    {# === Fin CODE PROMO === #}

                </div>

                </br></br>
            </div>
        </div>
    </div>
{% endblock %}
